model:
  class_path: rslearn.train.lightning_module.RslearnLightningModule
  init_args:
    model:
      class_path: rslearn.models.multitask.MultiTaskModel
      init_args:
        encoder:
          - class_path: rslp.helios.model.Helios
            init_args:
              checkpoint_path: "/weka/dfive-default/helios/checkpoints/yawenzzzz/lmim_cross_random_contrastive_decode_wc_osm_srtm/step220000"
              selector: ["encoder"]
              forward_kwargs:
                patch_size: 8
              random_initialization: true
          - class_path: rslearn.models.unet.UNetDecoder
            init_args:
              in_channels: [[8, 768]]
              out_channels: 128
              conv_layers_per_resolution: 2
              target_resolution_factor: 1
              num_channels:
                4: 256
                2: 128
                1: 128
        decoders:
          openstreetmap:
            - class_path: rslearn.models.conv.Conv
              init_args:
                in_channels: 128
                out_channels: 31
                kernel_size: 1
                activation:
                  class_path: torch.nn.Identity
            - class_path: rslearn.models.pick_features.PickFeatures
              init_args:
                indexes: [0]
                collapse: true
            - class_path: rslearn.train.tasks.segmentation.SegmentationHead
          cdl:
            - class_path: rslearn.models.conv.Conv
              init_args:
                in_channels: 128
                out_channels: 257
                kernel_size: 1
                activation:
                  class_path: torch.nn.Identity
            - class_path: rslearn.models.pick_features.PickFeatures
              init_args:
                indexes: [0]
                collapse: true
            - class_path: rslearn.train.tasks.segmentation.SegmentationHead
          worldcover:
            - class_path: rslearn.models.conv.Conv
              init_args:
                in_channels: 128
                out_channels: 102
                kernel_size: 1
                activation:
                  class_path: torch.nn.Identity
            - class_path: rslearn.models.pick_features.PickFeatures
              init_args:
                indexes: [0]
                collapse: true
            - class_path: rslearn.train.tasks.segmentation.SegmentationHead
          chm:
            - class_path: rslearn.models.conv.Conv
              init_args:
                in_channels: 128
                out_channels: 1
                kernel_size: 1
                activation:
                  class_path: torch.nn.Identity
            - class_path: rslearn.models.pick_features.PickFeatures
              init_args:
                indexes: [0]
                collapse: true
            - class_path: rslearn.train.tasks.per_pixel_regression.PerPixelRegressionHead
    scheduler:
      class_path: rslearn.train.scheduler.PlateauScheduler
      init_args:
        factor: 0.2
        patience: 2
        min_lr: 0
        cooldown: 10
    optimizer:
      class_path: rslearn.train.optimizer.AdamW
      init_args:
        lr: 0.00002
data:
  class_path: rslp.swin_pretrain.dataset.HeliosDataModule
  init_args:
    ds_path: /weka/dfive-default/helios/dataset/osm_sampling
    task:
      class_path: rslearn.train.tasks.multi_task.MultiTask
      init_args:
        tasks:
          openstreetmap:
            class_path: rslearn.train.tasks.segmentation.SegmentationTask
            init_args:
              num_classes: 31
              metric_kwargs:
                average: "micro"
              zero_is_invalid: true
          cdl:
            class_path: rslearn.train.tasks.segmentation.SegmentationTask
            init_args:
              num_classes: 257
              metric_kwargs:
                average: "micro"
              zero_is_invalid: true
          worldcover:
            class_path: rslearn.train.tasks.segmentation.SegmentationTask
            init_args:
              num_classes: 102
              metric_kwargs:
                average: "micro"
              zero_is_invalid: true
          chm:
            class_path: rslearn.train.tasks.per_pixel_regression.PerPixelRegressionTask
            init_args:
              scale_factor: 0.1
              metric_mode: "l1"
              nodata_value: 0
        input_mapping:
          openstreetmap:
            10_openstreetmap_raster: "targets"
          cdl:
            10_cdl: "targets"
          worldcover:
            10_worldcover: "targets"
          chm:
            10_wri_canopy_height_map: "targets"
    input_modalities:
      - "10_sentinel2_l2a_monthly"
    target_modalities:
      - "10_openstreetmap_raster"
      - "10_cdl"
      - "10_worldcover"
      - "10_wri_canopy_height_map"
    num_val_examples: 1024
    batch_size: 8
    num_workers: 32
    patch_size: 8
    min_size: 8
    max_size: 96
trainer:
  max_epochs: 500
  callbacks:
    - class_path: lightning.pytorch.callbacks.LearningRateMonitor
      init_args:
        logging_interval: "epoch"
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        save_top_k: 1
        save_last: true
        monitor: val_loss
        mode: min
rslp_project: swin_pretrain
rslp_experiment: pretrain_4mod_1conv_vit_random
