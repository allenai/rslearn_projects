model:
  class_path: rslearn.train.lightning_module.RslearnLightningModule
  init_args:
    model:
      class_path: rslearn.models.singletask.SingleTaskModel
      init_args:
        encoder:
          # This applies the OlmoEarth encoder on the inputs.
          - class_path: rslearn.models.olmoearth_pretrain.model.OlmoEarth
            init_args:
              # This can be one of:
              # - OLMOEARTH_V1_NANO
              # - OLMOEARTH_V1_TINY
              # - OLMOEARTH_V1_BASE
              # - OLMOEARTH_V1_LARGE
              model_id: OLMOEARTH_V1_BASE
              # The patch size should be set between 1 and 8, depending on the size of
              # the features being predicted, and the available compute (lower patch
              # sizes are slower).
              patch_size: 4
        decoder:
          # For the decoder, we apply UNetDecoder to upsample features to the input
          # resolution. It isn't really a UNet since we only have features at one
          # resolution.
          - class_path: rslearn.models.unet.UNetDecoder
            init_args:
              in_channels: [[4, 768]]
              out_channels: 2
              conv_layers_per_resolution: 2
              num_channels: {8: 512, 4: 512, 2: 256, 1: 128}
          # The SegmentationHead computes softmax and cross entropy loss.
          - class_path: rslearn.train.tasks.segmentation.SegmentationHead
    optimizer:
      class_path: rslearn.train.optimizer.AdamW
      init_args:
        lr: 0.0001
data:
  class_path: rslearn.train.data_module.RslearnDataModule
  init_args:
    path: '/weka/dfive-default/piperw/rslearn_projects/data/landslide/sen12landslides'
    inputs:
      # We read the four Sentinel-2 images materialized earlier.
      # OlmoEarth expects the input to be called "sentinel2_l2a".
      sentinel2_l2a:
        data_type: "raster"
        layers: ["pre_sentinel2", "post_sentinel2"]
        # This is the band order expected by  OlmoEarth.
        bands: ["B02", "B03", "B04", "B08", "B05", "B06", "B07", "B8A", "B11", "B12", "B01", "B09"]
        passthrough: true
        dtype: FLOAT32
        load_all_layers: true
      targets:
        data_type: "raster"
        layers: ["label"]
        bands: ["label"]
        dtype: FLOAT32
        is_target: true
    task:
      class_path: rslearn.train.tasks.segmentation.SegmentationTask
      init_args:
        num_classes: 2
        enable_miou_metric: true
        nodata_value: 2
    batch_size: 8
    num_workers: 32
    default_config:
      groups: ["1k_positives"]
      transforms:
        - class_path: rslearn.models.olmoearth_pretrain.norm.OlmoEarthNormalize
          init_args:
            band_names:
              sentinel2_l2a: ["B02", "B03", "B04", "B08", "B05", "B06", "B07", "B8A", "B11", "B12", "B01", "B09"]
    train_config:
      tags:
        split: "train"
    val_config:
      tags:
        split: "val"
    test_config:
      tags:
        split: "val"
    predict_config:
      groups: ["predict"]
      load_all_patches: true
      # We set patch_size=128 here to support the option of using larger windows during
      # prediction. Note that this controls the sliding window inference crop size.
      patch_size: 32
      # We use some overlap when we need to apply sliding window inference on large
      # windows to reduce border effects.
      overlap_ratio: 0.1
      skip_targets: true
trainer:
  max_epochs: 10
  callbacks:
    # Save the latest checkpoint (last.ckpt) as well as best one based on accuracy
    # metric.
    - class_path: lightning.pytorch.callbacks.ModelCheckpoint
      init_args:
        save_top_k: 1
        save_last: true
        monitor: val_accuracy
        mode: max
    # We find that freezing the model for the first few epochs helps to improve the
    # performance of the fine-tuned models.
    - class_path: rslearn.train.callbacks.freeze_unfreeze.FreezeUnfreeze
      init_args:
        module_selector: ["model", "encoder", 0]
        unfreeze_at_epoch: 10
    # The RslearnWriter is used during `model predict` to save the predicted outputs to
    # the rslearn dataset. It's not needed for training, so we comment it out here.
    # Uncomment and set output_layer when using this config for prediction.
    # - class_path: rslearn.train.prediction_writer.RslearnWriter
    #   init_args:
    #     # This path will be copied from data.init_args.path by rslearn.
    #     path: gs://rslearn-eai/datasets/landslide/sen12landslides_1k_positives/
    #     output_layer: segment
    #     selector: ["segment"]
# Here we enable automatic checkpoint management and logging to W&B.
# Set WANDB_MODE=offline to disable online logging.
project_name: landslides
run_name: sen12landslides_1k_base
management_dir: ${MANAGEMENT_DIR}
