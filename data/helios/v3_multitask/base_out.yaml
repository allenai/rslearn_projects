data:
  class_path: rslearn.train.data_module.MultiDatasetDataModule
  init_args:
    batch_size: 8
    dataset_configs:
      vessel_classification:
        class_path: rslearn.train.data_module.RslearnDataModule
        init_args:
          batch_size: 16
          default_config:
            transforms:
            - class_path: rslp.helios.norm.HeliosNormalize
              init_args:
                band_names:
                  landsat:
                  - B8
                  - B1
                  - B2
                  - B3
                  - B4
                  - B5
                  - B6
                  - B7
                  - B9
                  - B10
                  - B11
                config_fname: /opt/helios/data/norm_configs/computed.json
          inputs:
            label:
              data_type: vector
              is_target: true
              layers:
              - label
            landsat:
              bands:
              - B8
              - B1
              - B2
              - B3
              - B4
              - B5
              - B6
              - B7
              - B9
              - B10
              - B11
              data_type: raster
              dtype: FLOAT32
              layers:
              - landsat
              passthrough: true
          num_workers: 32
          path: /weka/dfive-default/rslearn-eai/datasets/landsat_vessel_detection/classifier/dataset_20250624
          task:
            class_path: rslearn.train.tasks.multi_task.MultiTask
            init_args:
              input_mapping:
                vessel_classification:
                  label: targets
                vessel_detection: &id001
                  targets: targets
              tasks:
                vessel_classification:
                  class_path: rslearn.train.tasks.classification.ClassificationTask
                  init_args:
                    allow_invalid: true
                    classes:
                    - correct
                    - incorrect
                    enable_f1_metric: true
                    metric_kwargs:
                      average: micro
                    property_name: label
                    skip_unknown_categories: true
                vessel_detection: &id002
                  class_path: rslearn.train.tasks.detection.DetectionTask
                  init_args:
                    box_size: 15
                    classes:
                    - unknown
                    - vessel
                    enable_f1_metric: true
                    enable_map_metric: true
                    exclude_by_center: true
                    f1_metric_kwargs:
                      cmp_mode: distance
                      cmp_threshold: 15
                      flatten_classes: true
                    f1_metric_thresholds:
                    - - 0.05
                      - 0.1
                      - 0.2
                      - 0.3
                      - 0.4
                      - 0.5
                      - 0.6
                      - 0.7
                      - 0.8
                      - 0.9
                      - 0.95
                    property_name: category
                    remap_values:
                    - - 0
                      - 1
                    - - 0
                      - 255
                    score_threshold: 0.7
          test_config:
            groups:
            - phase2a_completed
            tags:
              split: val
          train_config:
            groups:
            - selected_copy
            - phase2a_completed
            - phase3a_selected
            tags:
              split: train
          val_config:
            groups:
            - phase2a_completed
            tags:
              split: val
      vessel_detection:
        class_path: rslearn.train.data_module.RslearnDataModule
        init_args:
          batch_size: 8
          default_config:
            transforms:
            - class_path: rslp.transforms.mask.Mask
            - class_path: rslearn.train.transforms.concatenate.Concatenate
              init_args:
                output_selector: landsat
                selections:
                  image: []
            - class_path: rslp.helios.norm.HeliosNormalize
              init_args:
                band_names:
                  landsat:
                  - B8
                  - B1
                  - B2
                  - B3
                  - B4
                  - B5
                  - B6
                  - B7
                  - B9
                  - B10
                  - B11
                config_fname: /opt/helios/data/norm_configs/computed.json
          inputs:
            image:
              bands:
              - B8
              - B1
              - B2
              - B3
              - B4
              - B5
              - B6
              - B7
              - B9
              - B10
              - B11
              data_type: raster
              dtype: FLOAT32
              layers:
              - landsat
              passthrough: true
            mask:
              bands:
              - mask
              data_type: raster
              dtype: INT32
              is_target: true
              layers:
              - mask
              passthrough: true
            targets:
              data_type: vector
              is_target: true
              layers:
              - label
          num_workers: 16
          path: /weka/dfive-default/rslearn-eai/datasets/landsat_vessel_detection/detector/dataset_20250624
          task:
            class_path: rslearn.train.tasks.multi_task.MultiTask
            init_args:
              input_mapping:
                vessel_detection: *id001
              tasks:
                vessel_detection: *id002
          test_config:
            groups:
            - labels_utm
            load_all_patches: true
            patch_size: 128
            tags:
              split: val
          train_config:
            groups:
            - labels_utm
            load_all_patches: true
            patch_size: 128
            tags:
              split: train
            transforms:
            - class_path: rslp.transforms.mask.Mask
            - class_path: rslearn.train.transforms.concatenate.Concatenate
              init_args:
                output_selector: landsat
                selections:
                  image: []
            - class_path: rslp.helios.norm.HeliosNormalize
              init_args:
                band_names:
                  landsat:
                  - B8
                  - B1
                  - B2
                  - B3
                  - B4
                  - B5
                  - B6
                  - B7
                  - B9
                  - B10
                  - B11
                config_fname: /opt/helios/data/norm_configs/computed.json
          val_config:
            groups:
            - labels_utm
            load_all_patches: true
            patch_size: 128
            tags:
              split: val
    num_workers: 32
    task:
      class_path: rslearn.train.tasks.multi_task.MultiTask
      init_args:
        input_mapping:
          vessel_classification:
            label: targets
          vessel_detection:
            targets: targets
        tasks:
          vessel_classification:
            class_path: rslearn.train.tasks.classification.ClassificationTask
            init_args:
              allow_invalid: true
              classes:
              - correct
              - incorrect
              enable_f1_metric: true
              metric_kwargs:
                average: micro
              property_name: label
              skip_unknown_categories: true
          vessel_detection:
            class_path: rslearn.train.tasks.detection.DetectionTask
            init_args:
              box_size: 15
              classes:
              - unknown
              - vessel
              enable_f1_metric: true
              enable_map_metric: true
              exclude_by_center: true
              f1_metric_kwargs:
                cmp_mode: distance
                cmp_threshold: 15
                flatten_classes: true
              f1_metric_thresholds:
              - - 0.05
                - 0.1
                - 0.2
                - 0.3
                - 0.4
                - 0.5
                - 0.6
                - 0.7
                - 0.8
                - 0.9
                - 0.95
              property_name: category
              remap_values:
              - - 0
                - 1
              - - 0
                - 255
              score_threshold: 0.7
model:
  class_path: rslearn.train.lightning_module.RslearnLightningModule
  init_args:
    lr: 0.0001
    model:
      class_path: rslearn.models.multitask.MultiTaskModel
      init_args:
        lazy_decode: true
        decoders:
          vessel_classification:
          - class_path: rslearn.models.pooling_decoder.PoolingDecoder
            init_args:
              in_channels: 768
              out_channels: 2
          - class_path: rslearn.train.tasks.classification.ClassificationHead
          vessel_detection:
          - class_path: rslearn.models.faster_rcnn.FasterRCNN
            init_args:
              anchor_sizes:
              - - 32
              downsample_factors:
              - 8
              num_channels: 768
              num_classes: 2
        encoder:
        - class_path: rslp.helios.model.Helios
          init_args:
            checkpoint_path: /weka/dfive-default/helios/checkpoints/favyen/v0.2_base_latent_mim_128_alldata_random_fixed_modality_0.5/step320000
            forward_kwargs:
              patch_size: 8
            selector:
            - encoder
    plateau: true
    plateau_cooldown: 10
    plateau_factor: 0.2
    plateau_min_lr: 0
    plateau_patience: 2
    task:
      class_path: rslearn.train.tasks.multi_task.MultiTask
      init_args:
        input_mapping:
          vessel_classification:
            label: targets
          vessel_detection:
            targets: targets
        tasks:
          vessel_classification:
            class_path: rslearn.train.tasks.classification.ClassificationTask
            init_args:
              allow_invalid: true
              classes:
              - correct
              - incorrect
              enable_f1_metric: true
              metric_kwargs:
                average: micro
              property_name: label
              skip_unknown_categories: true
          vessel_detection:
            class_path: rslearn.train.tasks.detection.DetectionTask
            init_args:
              box_size: 15
              classes:
              - unknown
              - vessel
              enable_f1_metric: true
              enable_map_metric: true
              exclude_by_center: true
              f1_metric_kwargs:
                cmp_mode: distance
                cmp_threshold: 15
                flatten_classes: true
              f1_metric_thresholds:
              - - 0.05
                - 0.1
                - 0.2
                - 0.3
                - 0.4
                - 0.5
                - 0.6
                - 0.7
                - 0.8
                - 0.9
                - 0.95
              property_name: category
              remap_values:
              - - 0
                - 1
              - - 0
                - 255
              score_threshold: 0.7
rslp_experiment: placeholder
rslp_project: placeholder
trainer:
  callbacks:
  - class_path: lightning.pytorch.callbacks.LearningRateMonitor
    init_args:
      logging_interval: epoch
  - class_path: lightning.pytorch.callbacks.ModelCheckpoint
    init_args:
      mode: min
      monitor: val_loss
      save_last: true
      save_top_k: 1
  - class_path: rslearn.train.callbacks.freeze_unfreeze.FreezeUnfreeze
    init_args:
      module_selector:
      - model
      - encoder
      - 0
      unfreeze_at_epoch: 2
  max_epochs: 100
