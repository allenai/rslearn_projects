<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />

<style>
.legend {
	background-color: white;
	padding: 10px;
}
.legend-row {
	margin-top: 2px;
	cursor: pointer;
}
.legend-row-disabled {
	text-decoration: line-through;
}
.circle {
  height: 10px;
  width: 10px;
  border-radius: 50%;
  display: inline-block;
}
</style>

</head>
<body>

<div id="map" style="width: 100%; height: 100%"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script src="https://unpkg.com/leaflet.vectorgrid@latest/dist/Leaflet.VectorGrid.bundled.js"></script>
<script>

const imageZoom = 13 + 1;

const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
	maxZoom: 19,
	attribution: 'Â© OpenStreetMap',
});

let categories = [{
	name: "Agriculture",
	layer: "agriculture",
	color: "lime",
}, {
	name: "Mining",
	layer: "mining",
	color: "yellow",
}, {
	name: "Airstrip",
	layer: "airstrip",
	color: "pink",
}, {
	name: "Road",
	layer: "road",
	color: "orange",
}, {
	name: "Logging",
	layer: "logging",
	color: "purple",
}, {
	name: "Burned",
	layer: "burned",
	color: "red",
}, {
	name: "Landslide",
	layer: "landslide",
	color: "brown",
}, {
	name: "Hurricane",
	layer: "hurricane",
	color: "beige",
}, {
	name: "River",
	layer: "river",
	color: "cyan",
}];

let enabledCategories = {};
for(const category of categories) {
	enabledCategories[category.name] = true;
}

function getStyleDict() {
	let styleDict = {none: []};
	for(const category of categories) {
		if(!enabledCategories[category.name]) {
			styleDict[category.layer] = [];
			continue;
		}
		styleDict[category.layer] = function(properties, zoom) {
			return {color: category.color, fillColor: category.color, fillOpacity: 1, stroke: true, fill: true, weight: 1};
		};
	}
	return styleDict;
}

function getPbfLayer() {
	let pbfLayer = L.vectorGrid.protobuf('https://pub-956f3eb0f5974f37b9228e0a62f449bf.r2.dev/rslearn-public/forest_loss_driver/20240828_layered/tiles/{z}/{x}/{y}.pbf', {
		maxZoom: 15,
		maxNativeZoom: 12,
		vectorTileLayerStyles: getStyleDict(),
		interactive: true,
	});
	pbfLayer.on('click', function(e) {
		window.open('/?index=' + e.layer.properties.index, '_blank');
		L.DomEvent.stop(e);
	});
	return pbfLayer;
}

let pbfLayer = getPbfLayer();
const defaultLayers = [osmLayer, pbfLayer];
const toggleLayers = {
	"Google": L.tileLayer('http://{s}.google.com/vt?lyrs=s&x={x}&y={y}&z={z}', {
		maxZoom: 20,
		subdomains:['mt0','mt1','mt2','mt3'],
	}),
	"Forest Loss Events": pbfLayer,
};

const map = new L.Map('map', {
	crs: L.CRS.EPSG3857,
	layers: defaultLayers,
	zoom: 5,
	maxZoom: 15,
	center: [-9.8, -74.2],
});

let layerControl = L.control.layers({
	"OpenStreetMap": osmLayer,
}, toggleLayers).addTo(map);

var legend = L.control({position: 'bottomleft'});
legend.onAdd = function (map) {
    var div = L.DomUtil.create('div', 'info legend');

	let header = document.createElement("strong");
	header.setAttribute("style", "text-weight: bold")
	header.appendChild(document.createTextNode("Categories"));
	div.appendChild(header);

    for(let category of categories) {
		let cur_name = category.name;
		let row = document.createElement("div");
		row.classList.add("legend-row");

		let colorIcon = document.createElement("i");
		colorIcon.classList.add("circle");
		colorIcon.setAttribute("style", "background: " + category.color);
		row.appendChild(colorIcon);

		row.appendChild(document.createTextNode(" " + category.name));

		row.addEventListener("click", (e) => {
			enabledCategories[cur_name] = !enabledCategories[cur_name];
			map.removeLayer(pbfLayer);
			layerControl.removeLayer(pbfLayer);
			pbfLayer = getPbfLayer();
			layerControl.addOverlay(pbfLayer, "Forest Loss Events");
			map.addLayer(pbfLayer);

			if(enabledCategories[cur_name]) {
				row.classList.remove("legend-row-disabled");
			} else {
				row.classList.add("legend-row-disabled");
			}
		});
		div.appendChild(row);
	}

	return div;
};
legend.addTo(map);
</script>

</body>
</html>
