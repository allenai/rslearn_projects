version: "3.9"

services:
  # Define the base image
  base-image:
    build:
      context: ../..
      dockerfile: Dockerfile
    image: base-image:latest   # Tag it as "base-image"

  # Define the landsat-vessels service
  landsat-vessels:
    build:
      context: .
      dockerfile: Dockerfile
    shm_size: '10G'  # This adds the shared memory size
    depends_on:
      - base-image
    ports:
      - "5555:5555"
    environment:
      - RSLP_BUCKET
      - S3_ACCESS_KEY_ID
      - S3_SECRET_ACCESS_KEY
      - AWS_ACCESS_KEY_ID
      - AWS_SECRET_ACCESS_KEY
      - NVIDIA_VISIBLE_DEVICES=all  # Make all GPUs visible
    deploy:
      resources:
        reservations:
          devices:
            - capabilities: [gpu]  # Ensure this service can access GPUs
    runtime: nvidia  # Use the NVIDIA runtime
